<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stopwatch with Alarms + Picture-in-Picture</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: sans-serif; padding: 20px; background: black; color: white; }
    #time { font-size: 2em; margin-bottom: 10px; }
    button { margin: 5px; }
    .alarm-item {
      display: flex;
      align-items: center;
      margin: 5px 0;
    }
    .alarm-item span { flex: 1; }
  </style>
</head>
<body>
  <h2>Stopwatch with Alarms</h2>
  <div id="time">00:00.000</div>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
  <button id="resetBtn">Reset</button>
  <button id="wakeLockBtn">Keep Screen On: OFF</button>
  <button id="pipBtn">Show Picture in Picture</button>
  
  <h3>Add Alarm (MM:SS)</h3>
  <input type="number" id="minInput" min="0" placeholder="Min" style="width:60px;">
  <input type="number" id="secInput" min="0" max="59" placeholder="Sec" style="width:60px;">
  <button id="addAlarmBtn">Add Alarm</button>

  <h3>Alarms</h3>
  <div id="alarms"></div>

  <audio id="beep" preload="auto">
    <source src="./alarm.mp3" type="audio/ogg">
  </audio>

  <!-- Hidden canvas and video for PiP -->
  <canvas id="pipCanvas" width="400" height="150" style="display:none;"></canvas>
  <video id="pipVideo" style="display:none;" muted playsinline></video>

  <script>
    let startTime = null;
    let elapsed = 0;
    let timer = null;

    const timeDisplay = document.getElementById("time");
    const beep = document.getElementById("beep");
    const alarmsContainer = document.getElementById("alarms");

    // --- Stopwatch core logic ---
    function updateTime() {
      const now = Date.now();
      const total = elapsed + (now - startTime);
      const totalSeconds = Math.floor(total / 1000);
      const min = Math.floor(totalSeconds / 60);
      const sec = totalSeconds % 60;
      const ms = total % 1000;
      const text = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
      timeDisplay.textContent = text;
      checkAlarms(min, sec);
      drawPiPFrame(text);
    }

    document.getElementById("startBtn").onclick = () => {
      if (!timer) {
        startTime = Date.now();
        timer = setInterval(updateTime, 50);
      }
    };

    document.getElementById("stopBtn").onclick = () => {
      if (timer) {
        elapsed += Date.now() - startTime;
        clearInterval(timer);
        timer = null;
      }
    };

    document.getElementById("resetBtn").onclick = () => {
      clearInterval(timer);
      timer = null;
      startTime = null;
      elapsed = 0;
      timeDisplay.textContent = "00:00.000";
      drawPiPFrame("00:00.000");
    };

    // --- Alarm system ---
    function addAlarm(min, sec) {
      const alarms = getAlarms();
      alarms.push({min, sec});
      localStorage.setItem("stopwatchAlarms", JSON.stringify(alarms));
      renderAlarms();
    }

    function removeAlarm(index) {
      const alarms = getAlarms();
      alarms.splice(index, 1);
      localStorage.setItem("stopwatchAlarms", JSON.stringify(alarms));
      renderAlarms();
    }

    function getAlarms() {
      return JSON.parse(localStorage.getItem("stopwatchAlarms") || "[]");
    }

    function renderAlarms() {
      alarmsContainer.innerHTML = "";
      getAlarms().forEach((a, i) => {
        const div = document.createElement("div");
        div.className = "alarm-item";
        div.innerHTML = `<span>${String(a.min).padStart(2,'0')}:${String(a.sec).padStart(2,'0')}</span>`;
        const btn = document.createElement("button");
        btn.textContent = "Remove";
        btn.onclick = () => removeAlarm(i);
        div.appendChild(btn);
        alarmsContainer.appendChild(div);
      });
    }

    function checkAlarms(min, sec) {
      getAlarms().forEach(a => {
        if (a.min === min && a.sec === sec) {
          triggerAlarm();
        }
      });
    }

    function triggerAlarm() {
      beep.currentTime = 0;
      beep.play();
      if (navigator.vibrate) navigator.vibrate([500, 100, 500]);
    }

    document.getElementById("addAlarmBtn").onclick = () => {
      const min = parseInt(document.getElementById("minInput").value || "0", 10);
      const sec = parseInt(document.getElementById("secInput").value || "0", 10);
      if (min >= 0 && sec >= 0 && sec < 60) addAlarm(min, sec);
    };

    renderAlarms();

    // --- Wake Lock ---
    let wakeLock = null;
    const wakeLockBtn = document.getElementById("wakeLockBtn");

    async function requestWakeLock() {
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        wakeLockBtn.textContent = "Keep Screen On: ON";
        wakeLock.addEventListener("release", () => {
          wakeLock = null;
          wakeLockBtn.textContent = "Keep Screen On: OFF";
        });
      } catch (err) {
        console.error(err);
        alert("Wake Lock failed: " + err.message);
      }
    }

    async function toggleWakeLock() {
      if (!("wakeLock" in navigator)) {
        alert("Wake Lock API not supported on this device/browser.");
        return;
      }
      if (wakeLock) {
        await wakeLock.release();
        wakeLock = null;
        wakeLockBtn.textContent = "Keep Screen On: OFF";
      } else {
        await requestWakeLock();
      }
    }

    document.addEventListener("visibilitychange", () => {
      if (wakeLock !== null && document.visibilityState === "visible") {
        requestWakeLock();
      }
    });

    wakeLockBtn.onclick = toggleWakeLock;

    // --- Picture-in-Picture setup ---
    const pipCanvas = document.getElementById("pipCanvas");
    const pipCtx = pipCanvas.getContext("2d");
    const pipVideo = document.getElementById("pipVideo");
    let pipStream = pipCanvas.captureStream();
    pipVideo.srcObject = pipStream;

    function drawPiPFrame(text) {
      pipCtx.fillStyle = "black";
      pipCtx.fillRect(0, 0, pipCanvas.width, pipCanvas.height);
      pipCtx.fillStyle = "white";
      pipCtx.font = "bold 48px monospace";
      pipCtx.textAlign = "center";
      pipCtx.textBaseline = "middle";
      pipCtx.fillText(text, pipCanvas.width / 2, pipCanvas.height / 2);
    }
    drawPiPFrame("00:00.000");

    const pipBtn = document.getElementById("pipBtn");
    pipBtn.onclick = async () => {
      try {
        if (document.pictureInPictureElement) {
          await document.exitPictureInPicture();
        } else {
          await pipVideo.play();
          await pipVideo.requestPictureInPicture();
        }
      } catch (err) {
        console.error("PiP failed:", err);
        alert("Picture-in-Picture failed: " + err.message);
      }
    };
  </script>
</body>
</html>
